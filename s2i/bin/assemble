#!/bin/bash -e
#
# S2I assemble script for the 'airhacks/s2i-payara' image.
# If the 'airhacks/s2i-payara' assemble script is executed with the '-h' flag, print the usage.
if [[ "$1" == "-h" ]]; then
	exec /usr/libexec/s2i/usage
fi

SRC=/tmp/src
PREBOOT_FILE=$SRC/asadmin-preboot
printenv
echo "### Installing Thin WARs $(ls $SRC/*.war) into ${DEPLOYMENT_DIR}"
cp -f ${SRC}/*.war ${DEPLOYMENT_DIR}

if [ -f $SRC/ext/*.jar ]; then
		echo "### Installing JDBC Drivers: $(ls $SRC/jdbc/*.jar)"
		cp -f ${SRC}/ext/*.jar ${INSTALL_DIR}/${PAYARA_ARCHIVE}/glassfish/domains/domain1/lib/ext
	else
		echo "### Not libraries found in /ext, skipping library installation"
fi

echo "Preboot found: "
cat ${PREBOOT_FILE}
echo "---------------"
echo "Configuring: ${DOMAIN_NAME}"
${PAYARA_HOME}/bin/asadmin start-domain --prebootcommandfile ${PREBOOT_FILE} ${DOMAIN_NAME} && \
${PAYARA_HOME}/bin/asadmin stop-domain ${DOMAIN_NAME}
