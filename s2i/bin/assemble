#!/bin/bash -e
#
if [[ "$1" == "-h" ]]; then
	exec /usr/libexec/s2i/usage
fi

SRC=/tmp/src
PREBOOT_FILE=$SRC/asadmin-preboot
printenv
echo "### Installing Thin WARs $(ls $SRC/*.war) into ${DEPLOYMENT_DIR}"
cp -f ${SRC}/*.war ${DEPLOYMENT_DIR}

if [ -f $SRC/ext/*.jar ]; then
		echo "### Installing JDBC Drivers: $(ls $SRC/ext/*.jar)"
		cp -f ${SRC}/ext/*.jar ${INSTALL_DIR}/${PAYARA_ARCHIVE}/glassfish/domains/domain1/lib/ext
	else
		echo "### Not libraries found in /ext, skipping library installation"
fi

if [ -f ${PREBOOT_FILE} ]; then
		echo "Preboot found: "
		cat ${PREBOOT_FILE}
		echo "---------------"
		echo "Configuring: ${DOMAIN_NME}"
		${PAYARA_HOME}/bin/asadmin start-domain --prebootcommandfile ${PREBOOT_FILE} ${DOMAIN_NAME} && 
		${PAYARA_HOME}/bin/asadmin stop-domain ${DOMAIN_NAME}
	else
		echo "### No ${PREBOOT_FILE} found -- running vanilla Payara"
fi

find ${INSTALL_DIR} -type d  -exec chmod a+rwx {} \;
find ${INSTALL_DIR} -type f  -exec chmod a+rw  {} \;
